<!doctype html>
<html class="fixed sidebar-light">
<head>
    <meta charset="UTF-8">

    <title>Monte Carlo Pi Example · swave</title>
    <meta name="keywords" content="scala, streams, streaming, reactive, asynchronous, non-blocking" />
    <meta name="description" content='A Reactive Streams infrastructure implementation in Scala'>
    <meta name="author" content="The swave team">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700,800|Shadows+Into+Light" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" />
    <link rel="stylesheet" href="../../assets/css/theme.css" />
    <link rel="stylesheet" href="../../assets/css/skins/default.css" />
    <link rel="stylesheet" href="../../assets/css/theme-custom.css">
    <link rel="stylesheet" href="../../assets/vendor/highlight/github.css">

    <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="apple-mobile-web-app-title" content="swave.io">
    <meta name="application-name" content="swave.io">
    <meta name="theme-color" content="#ffffff">

    <script src="../../assets/vendor/modernizr/modernizr.js"></script>
</head>
<body >
<section class="body">

    <header class="header">
        <div class="logo-container">
            <a href="../../index.html" class="logo">
                <img src="../../assets/img/swave-logo.svg" height="35" alt="swave" />
            </a>
            <div class="visible-xs toggle-sidebar-left" data-toggle-class="sidebar-left-opened" data-target="html" data-fire-event="sidebar-left-opened">
                <i class="fa fa-bars" aria-label="Toggle sidebar"></i>
            </div>
        </div>

        <div class="header-right hidden-xs">
            <ul class="social-icons">
                <li class="social-icons-github"><a href="https://github.com/sirthias/swave/" target="_blank" title="Github"><i class="fa fa-github"></i></a></li>
                <li class="social-icons-email"><a href="https://groups.google.com/forum/#!forum/swave-user" target="_blank" title="Mailing List"><i class="fa fa-envelope"></i></a></li>
                <li class="social-icons-twitter"><a href="https://twitter.com/swaveio/" target="_blank" title="Twitter"><i class="fa fa-twitter"></i></a></li>
            </ul>
            <div id="talks-link">
                <a href="../../introduction/talks-on-swave.html" title="Watch the latest introductory talks for swave!">
                    <i class="fa fa-chevron-right" aria-hidden="true"></i>&nbsp;
                    <i class="fa fa-video-camera" aria-hidden="true"></i>&nbsp;Watch an intro talk on swave!&nbsp;
                    <i class="fa fa-chevron-left" aria-hidden="true"></i>
                </a>
            </div>
        </div>
    </header>

    <div class="inner-wrapper">
        <aside id="sidebar-left" class="sidebar-left">

            <div class="sidebar-header">
                <div class="sidebar-title">
                    Content
                </div>
                <div class="sidebar-toggle hidden-xs" data-toggle-class="sidebar-left-collapsed" data-target="html" data-fire-event="sidebar-left-toggle">
                    <i class="fa fa-bars" aria-label="Toggle sidebar"></i>
                </div>
            </div>

            <div class="nano">
                <div class="nano-content">
                    <nav id="menu" class="nav-main" role="navigation">
                        <ul class="nav nav-main">
                          <li class="nav-parent"><a><i class="fa fa-blind" aria-hidden="true"></i><span>Introduction</span></a>
                          <ul class="nav nav-children">
                            <li><a href="../../introduction/overview.html">Overview</a></li>
                            <li><a href="../../introduction/reactive-streams.html">Reactive Streams</a></li>
                            <li><a href="../../introduction/swave-vs-akka-stream.html"><em>swave</em> vs. Akka-Stream</a></li>
                            <li><a href="../../introduction/talks-on-swave.html">Talks on <em>swave</em></a></li>
                          </ul></li>
                          <li class="nav-parent nav-expanded nav-active"><a><i class="fa fa-book" aria-hidden="true"></i><span>User Documentation</span></a>
                          <ul class="nav nav-children">
                            <li class="nav-parent nav-expanded nav-active"><a>Show-Off</a>
                            <ul class="nav nav-children">
                              <li><a href="../../usage/show-off/overview.html">Show-Off Overview</a></li>
                              <li><a href="../../usage/show-off/md5.html">MD5 Example</a></li>
                              <li><a href="../../usage/show-off/fahrenheit.html">Fahrenheit Example</a></li>
                              <li class="nav-expanded nav-active"><a href="../../usage/show-off/monte-carlo-pi.html">Monte Carlo Pi Example</a></li>
                              <li><a href="../../usage/show-off/fibonacci.html">Fibonacci Example</a></li>
                            </ul></li>
                            <li><a href="../../usage/setup.html">Setup</a></li>
                            <li><a href="../../usage/quick-start.html">Quick Start</a></li>
                            <li><a href="../../usage/basics.html">Basics</a></li>
                            <li><a href="../../usage/spouts.html">Spouts</a></li>
                            <li><a href="../../usage/drains.html">Drains</a></li>
                            <li class="nav-parent"><a>Transformations</a>
                            <ul class="nav nav-children">
                              <li><a href="../../usage/transformations/overview.html">Transformations Overview</a></li>
                              <li><a href="../../usage/transformations/simple.html">Simple Transformations</a></li>
                              <li><a href="../../usage/transformations/fan-ins.html">Fan-Ins</a></li>
                              <li><a href="../../usage/transformations/fan-outs.html">Fan-Outs</a></li>
                              <li><a href="../../usage/transformations/streams-of-streams.html">Streams-of-Streams</a></li>
                              <li><a href="../../usage/transformations/relationships.html">Fan-In/Out Relationships</a></li>
                              <li><a href="../../usage/transformations/couplings.html">Couplings</a></li>
                              <li><a href="../../usage/transformations/reference/index.html">Transformation Reference</a></li>
                            </ul></li>
                            <li class="nav-parent"><a>Further Topics</a>
                            <ul class="nav nav-children">
                              <li><a href="../../usage/further/sync-vs-async.html">Sync vs. Async</a></li>
                              <li><a href="../../usage/further/pipes.html">Pipes</a></li>
                              <li><a href="../../usage/further/modules.html">Modules</a></li>
                              <li><a href="../../usage/further/debugging.html">Debugging</a></li>
                              <li><a href="../../usage/further/rendering.html">Rendering</a></li>
                              <li><a href="../../usage/further/configuration.html">Configuration</a></li>
                              <li><a href="../../usage/further/best-practices.html">Best Practices</a></li>
                            </ul></li>
                            <li class="nav-parent"><a>Domain Adapters</a>
                            <ul class="nav nav-children">
                              <li><a href="../../usage/domain/file-io.html">File IO</a></li>
                              <li><a href="../../usage/domain/tcp.html">Network IO (TCP)</a></li>
                              <li><a href="../../usage/domain/text.html">Text Transformations</a></li>
                              <li><a href="../../usage/domain/hash.html">Hashing Support</a></li>
                            </ul></li>
                            <li><a href="../../usage/swave-core-api.html">API Docs (ScalaDoc)</a></li>
                            <li><a href="../../usage/swave-akka-compat/index.html">swave-akka-compat</a></li>
                            <li><a href="../../usage/swave-scodec-compat/index.html">swave-scodec-compat</a></li>
                            <li><a href="../../usage/swave-testkit/index.html">swave-testkit</a></li>
                          </ul></li>
                          <li><a href="../../dev/index.html"><i class="fa fa-cogs" aria-hidden="true"></i><span>Developer Documentation</span></a></li>
                          <li class="nav-parent"><a><i class="fa fa-info-circle" aria-hidden="true"></i><span>Project Info</span></a>
                          <ul class="nav nav-children">
                            <li><a href="../../project/license.html">License</a></li>
                            <li><a href="../../project/contributing.html">Contributing</a></li>
                            <li><a href="../../project/changelog.html">Changelog</a></li>
                            <li><a href="../../project/sponsors.html">Sponsors</a></li>
                            <li><a href="../../project/references.html">References</a></li>
                          </ul></li>
                          <li><a href="../../support.html"><i class="fa fa-users" aria-hidden="true"></i><span>Support</span></a></li>
                        </ul>
                    </nav>
                </div>

                <script>
                    // Maintain Scroll Position
                    if (typeof localStorage !== 'undefined') {
                        if (localStorage.getItem('sidebar-left-position') !== null) {
                            var initialPosition = localStorage.getItem('sidebar-left-position'),
                                    sidebarLeft = document.querySelector('#sidebar-left .nano-content');

                            sidebarLeft.scrollTop = initialPosition;
                        }
                    }
                </script>

            </div>

        </aside>

        <section role="main" class="content-body">
            <header class="page-header">
                <ul class="breadcrumbs">
                  <li><a href="../../index.html"><i class="fa fa-home"></i></a></li>
                  <li><a href="../../usage/index.html">User Documentation</a></li>
                  <li><a href="../../usage/show-off/index.html">Show-Off</a></li>
                  <li>Monte Carlo Pi Example</li>
                </ul>
            </header>
            <div id="main-content">
                <!-- start: page -->
<h1><a href="#monte-carlo-pi-example" name="monte-carlo-pi-example" class="anchor"><span class="anchor-link"></span></a>Monte Carlo Pi Example</h1>
<p>This example is a slightly adapted version of the one that has been shown in a few <a href="../../introduction/talks-on-swave.html">talks on swave</a> in the past.<br/> It implements a simple approximation of Pi via the Monte Carlo method, whose basic idea can be illustrated like this:</p><p class="centered"><img src="../../assets/img/pi.svg" alt="Approximating Pi with the Monte Carlo method" /></p>
<p>If we&rsquo;d shoot holes through this unit square at random points the share of the holes that are located in the grey area would asymptotically approach π/4 as we increase the number of shots.</p>
<p>There are many ways in which a simulation of this method can be implemented in code.<br/> Here is a stream-based solution, which is intentionally somewhat convoluted to show off a few of <em>swave&rsquo;s</em> features:</p>
<pre><code class="scala">import swave.core.util.XorShiftRandom
import swave.core._

implicit val env = StreamEnv()

val random = XorShiftRandom()

// format: OFF
Spout.continually(random.nextDouble())
  .grouped(2)
  .map { case x +: y +: Nil =&gt; Point(x, y) }
  .fanOutBroadcast()
    .sub.filter(_.isInner).map(_ =&gt; InnerSample).end
    .sub.filterNot(_.isInner).map(_ =&gt; OuterSample).end
  .fanInMerge()
  .scan(State(0, 0)) { _ withNextSample _ }
  .drop(1)
  .injectSequential           // these three transformations together have
  .map(_ drop 999999 take 1)  // the same effect as `.takeEveryNth(1000000)`
  .flattenConcat()            // (in fact, this is how `takeEveryNth` is implemented)
  .map(state ⇒ f&quot;After ${state.totalSamples}%,10d samples π is approximated as ${state.π}%.6f&quot;)
  .take(50)
  .foreach(println)

val time = System.currentTimeMillis() - env.startTime
println(f&quot;Done. Total time: $time%,6d ms, Throughput: ${50000.0 / time}%.3fM samples/sec\n&quot;)

//////////////// MODEL ///////////////

case class Point(x: Double, y: Double) {
  def isInner: Boolean = x * x + y * y &lt; 1.0
}

sealed trait Sample
case object InnerSample extends Sample
case object OuterSample extends Sample

case class State(totalSamples: Long, inCircle: Long) {
  def π: Double = (inCircle.toDouble / totalSamples) * 4.0
  def withNextSample(sample: Sample) =
    State(totalSamples + 1, if (sample == InnerSample) inCircle + 1 else inCircle)
}</code></pre>
<p>When this code is run it generates 50 mio samples, at maximum speed, to approximate π using the Monte Carlo method. After each 1 mio samples one line of progress information is printed to console. </p>
<p>The streams setup contains elements from all five basic groups of stream transformations: <a href="../transformations/simple.html">simple transformations</a>, <a href="../transformations/fan-outs.html">fan-outs</a>, <a href="../transformations/fan-ins.html">fan-ins</a>, <a href="../transformations/streams-of-streams.html#injecting-transformations">injects</a> and <a href="../transformations/streams-of-streams.html#flattening-transformations">flattenings</a>. The implemented stream graph can be visualized like this. </p><p class="centered"><img src="../../assets/img/pi-stream.svg" alt="Monte Carlo Pi Stream Graph" /></p>
<p>One thing that&rsquo;s interesting about this example is that everything is running synchronously (yet without any blocking) on the caller thread. There are no stages in the graph that require asynchronous dispatch and thus <em>swave</em> will run it entirely without moving execution to another thread, which, in simple and &ldquo;small&rdquo; cases like this one, is often the fastest way to run a stream.</p>
<h2><a href="#rate-detaching" name="rate-detaching" class="anchor"><span class="anchor-link"></span></a>Rate Detaching</h2>
<p>To demonstrate another feature called &ldquo;rate detaching&rdquo; let&rsquo;s transform the example slightly. So far we&rsquo;ve printed a line of status information after every 1 mio samples. While this probably works ok on your machine it might end up generating too much output on really fast machines and too little if the machine is really slow.</p>
<p>We can fix this by letting the stream produce a status update <em>once a second</em>, i.e. independently of the number of generated samples:</p>
<pre><code class="scala">import scala.util.{Failure, Success}
import scala.concurrent.duration._
import swave.core.util.XorShiftRandom
import swave.core._

implicit val env = StreamEnv()
import env.defaultDispatcher // for the future transformations below

val random = XorShiftRandom()

Spout.continually(random.nextDouble())
  .grouped(2)
  .map { case x +: y +: Nil =&gt; Point(x, y) }
  .fanOutBroadcast()
    .sub.filter(_.isInner).map(_ =&gt; InnerSample).end
    .sub.filterNot(_.isInner).map(_ =&gt; OuterSample).end
  .fanInMerge()
  .scan(State(0, 0)) { _ withNextSample _ }
  .conflateToLast
  .throttle(1, per = 1.second, burst = 0)
  .onElement(state =&gt;
    println(f&quot;After ${state.totalSamples}%,10d samples π is approximated as ${state.π}%.6f&quot;))
  .take(20)
  .drainToLast()
  .onComplete {
    case Success(State(totalSamples, _)) =&gt;
      val time = System.currentTimeMillis() - env.startTime
      val throughput = totalSamples / 1000.0 / time
      println(f&quot;Done. Total time: $time%,6d ms, Throughput: $throughput%.3fM samples/sec\n&quot;)
      env.shutdown()

    case Failure(e) =&gt; println(e)
  }

println(&quot;Main thread exit.&quot;)

//////////////// MODEL ///////////////

case class Point(x: Double, y: Double) {
  def isInner: Boolean = x * x + y * y &lt; 1.0
}

sealed trait Sample
case object InnerSample extends Sample
case object OuterSample extends Sample

case class State(totalSamples: Long, inCircle: Long) {
  def π: Double = (inCircle.toDouble / totalSamples) * 4.0
  def withNextSample(sample: Sample) =
    State(totalSamples + 1, if (sample == InnerSample) inCircle + 1 else inCircle)
}</code></pre>
<p>Up to the <a href="../transformations/reference/scan.html">scan</a> stage everything has stayed as before. But rather than then simply filtering for every million-th element we use <a href="../transformations/reference/conflateToLast.html">conflateToLast</a>, which is one frequently used incarnation of the more general <a href="../transformations/reference/conflate.html">conflate</a>. <a href="../transformations/reference/conflate.html">conflate</a>, together with its sibling <a href="../transformations/reference/expand.html">expand</a>, are the two basic variants of transformations that perform &ldquo;rate detaching&rdquo;: They decouple their downstream&rsquo;s request rate from their upstream&rsquo;s production rate.</p>
<p>In our case we want the upstream to run at full speed, dropping all incoming elements that the downstream cannot digest. Whenever the downstream requests one element we want it to receive the most current element from upstream. This is exactly what <a href="../transformations/reference/conflateToLast.html">conflateToLast</a> does.</p>
<p>Apart from the difference in how status update lines are printed there is another important difference between this version and the one above: The stream now runs asynchronously off the caller thread. This is caused by the <a href="../transformations/reference/throttle.html">throttle</a> transformation, which must react to asynchronous timer signals and thus cannot run purely on the caller thread.</p>
                <div class="nav-next">
                    <p><strong>Next:</strong> <a href="../../usage/show-off/fibonacci.html">Fibonacci Example</a></p>
                </div>
                <!-- end: page -->
            </div>
        </section>
    </div>
</section>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="../../assets/vendor/jquery.browser.mobile/jquery.browser.mobile.js"></script>
<script src="../../assets/vendor/nanoscroller/nanoscroller.js"></script>
<script src="../../assets/vendor/highlight/highlight.js"></script>
<script src="../../assets/js/theme.js"></script>
<script src="../../assets/js/theme.init.js"></script>

</body>
</html>